# Programming Bitcoin in TypeScript

This repository is a TypeScript port of the exercises in Jimmy Song's Programming Bitcoin book. The book was originally coded with Python. Everything done in this repository is performed using TypeScript and Node.js 12+, even the Elliptic Curve code.

Here are some of the changes/challenge with porting to Node.js

* This port uses the [BigInt](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt) type to perform elliptic curve cryptography. This code is mostly found in [src/ecc](src/ecc). While BigInt finally allows us to do some neat stuff (and support 64-bit integers) it does not have constant time operations and is not suitable for cryptography. So this code is just an exercise.
* JavaScript does not support operator overloading. Instead I created types that support interface-based math operations. [IOperable](https://github.com/bmancini55/coding-bitcoin/blob/master/src/ecc/Operable.ts) [IntElement](https://github.com/bmancini55/coding-bitcoin/blob/master/src/ecc/IntElement.ts) [FieldElement](https://github.com/bmancini55/coding-bitcoin/blob/master/src/ecc/FieldElement.ts)
* The Python example uses a `modpow` function to perform modular exponentiation efficiently. Neither BigInt nor Node.js have this capability. I created a `modpow` function that allows for efficient modular exponentiation of large numbers (such as those used in secp256k1). [modpow](https://github.com/bmancini55/coding-bitcoin/blob/master/src/util/BigIntMath.ts#L41)
* The `%` operator available to `BigInt` is actually the remainder operator, which means it allows negative numbers and is a problem for subtraction. A helper function was created that is heavily used in the ECC code. [mod](https://github.com/bmancini55/coding-bitcoin/blob/master/src/util/BigIntMath.ts#L18)
* There is not a `divmod` function, one has been added to return a tuple of the quotient and remainder. [divmod](https://github.com/bmancini55/coding-bitcoin/blob/master/src/util/BigIntMath.ts#L64)
* Node misses functionality for converting between `BigInt` and `Buffer`. I've create helper functions to easily go between the two. [bigToBuf, bigToBufLE, bigFromBuf, bigFromBufLE](https://github.com/bmancini55/coding-bitcoin/blob/master/src/util/BigIntUtil.ts)
* Python allows for blocked reads from an iostream. The parsing methods require blocking until a specific number of bytes can be read off a stream. Node.js streams are event based and have two modes of operation: flowing and paused. Flowing mode pushes data to events as it is received, which is of little use here. Paused mode requires the use of the `read(len)` method to pull data off the stream. The challenge is that `read(len)` will return `null` if the bytes are not available on the stream yet. Then, you must wait for the `readable` event to be emitted before you should try `read(len)` again. The `StreamReader` helper class was created to create an async blockable read method over a stream. [StreamReader](https://github.com/bmancini55/coding-bitcoin/blob/master/src/util/StreamReader.ts)
* Because IO in Node.js is async, reading from streams or fetching from remote sources has cause async methods to be sprinkled throughout the application.

